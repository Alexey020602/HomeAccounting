@page "/Budgets"
@using global::Budgets.Contracts.GetBudgets
@using global::Budgets.UI.BudgetState
@using MaybeResults
@using Microsoft.AspNetCore.Authorization
@using Shared.Utils.Results
@using Shared.Blazor.Components
@attribute [Authorize]
@inject IBudgetsStateService BudgetsStateService
@inject IBudgetsApi BudgetsApi

<MudContainer MaxWidth="MaxWidth.Medium">
    <MaybeComponent TResult="IReadOnlyCollection<Budget>" Result="BudgetsResult" Context="budgets">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h5">Выберите бюджет, с которым вы хотите работать</MudText>
            </MudCardHeader>
            
            <MudCardContent>
                <MudList T="Budget" ReadOnly="true">
                    @foreach (var budget in budgets)
                    {
                        @{
                            var selected = SelectedBudget == budget
                                @<MudListItem 
                                     T="Budget" 
                                     Text="@budget.Name"
                                     Icon="@(selected ? @Icons.Material.Filled.Check : null)" 
                                     OnClick="@(async () => await SelectBudget(budget))"/>
                        }
                    }
                </MudList>
            </MudCardContent>
        </MudCard>
    </MaybeComponent>
</MudContainer>

@code {
    private IMaybe<IReadOnlyCollection<Budget>>? BudgetsResult { get; set; }
    private Budget? SelectedBudget { get; set; }
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        BudgetsResult = await BudgetsApi.GetBudgets(new GetBudgetsHttpRequest()).TryAsync();
    }

    private async ValueTask SelectBudget(Budget budget)
    {
        await BudgetsStateService.SelectBudget(budget);
        SelectedBudget = budget;
    }
}